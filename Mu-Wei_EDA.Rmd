---
title: "Life Expectancy by Year"
author: "Mu-Wei Chung"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(plotly)
```

# Life Expectancy Dataset

[Life Expectancy](https://ourworldindata.org/life-expectancy#all-charts) dataset from Our World in Data.

```{r}
le_df <- read_csv("data/life-expectancy.csv")
glimpse(le_df)
```

## Cleaning

```{r}
le_clean <- janitor::clean_names(le_df)
# rename column
le_clean <- le_clean %>% 
  rename(period_life_expect = period_life_expectancy_at_birth_sex_all_age_0)
glimpse(le_clean)
```
## Entity

It include countries, continents, world, groups of different development status and income levels.

```{r}
le_clean %>% pull(entity) %>% unique()
```

## Missing values

```{r}
visdat::vis_miss(le_clean)
```

Which entities are missing codes? 

Continents, Regions by Income and development status

```{r}
le_clean %>% 
  filter(is.na(code)) %>% 
  select(entity) %>% 
  distinct()
```

## World Life Expectancy by Year

```{r}
p <- le_clean %>% 
  filter(entity == "World") %>% 
  ggplot(aes(x = year, y = period_life_expect)) +
  geom_line() +
  labs(title = "World Life Expectancy by Year",
       x = "Year",
       y = "Life Expectancy at Birth (years)")
ggplotly(p)
```

## Looking into different development status regions

```{r}
development_status <- stringr::str_subset(le_clean$entity, regex("devel", ignore_case = TRUE)) %>% unique()

p <- le_clean %>%
  filter(entity %in% development_status) %>%
  ggplot(aes(x = year, 
             y = period_life_expect,
             color = entity)) +
  geom_line() + 
  labs(title = "Life Expectancy by Year",
       x = "Year",
       y = "Life Expectancy at Birth (years)")
ggplotly(p)
```

How many countries have data before 1950? 

```{r}
le_clean %>% drop_na(code) %>%
  filter(year < 1950) %>% 
  pull(entity) %>% 
  unique() %>% 
  length()
```

Only 87 of 238 countries have data before 1950.

```{r}
le_clean %>% drop_na(code) %>%
  filter(year >= 1950) %>% 
  group_by(entity) %>% 
  count() %>% 
  filter(n == 72) %>%
  pull(entity) %>%
  unique() %>%
  length()
  
```

237 of 238 countries have data every year since 1950.

```{r}
le_clean %>% drop_na(code) %>%
  pull(entity) %>%
  unique() %>% 
  length()
```


# Difference in Life Expectancy

Create a new column that calculates the difference in life expectancy from the previous year.

```{r}
le_clean <- le_clean %>% 
  group_by(entity) %>% 
  mutate(diff = c(NA, diff(period_life_expect))) %>%
  ungroup()
```

```{r}
p <- le_clean %>%
  filter(entity %in% development_status) %>%
  drop_na(diff) %>%
  ggplot(aes(x = year, 
             y = diff,
             color = entity)) +
  geom_line() + 
  geom_abline(intercept = 0.243, slope = 0, color = "black", linetype = "dotted") +
  labs(title = "Life Expectancy Diff by Year",
       x = "Year",
       y = "Life Expectancy at Birth (years)")
ggplotly(p)
```

# Time Series Analysis

## Convert dataframes to time series

```{r}
# create a list of 3 dataframes
le_dev_ls <- list()
for (dev in development_status) {
  le_dev_ls[[dev]] <- le_clean %>% 
    filter(entity == dev) %>%
    select(period_life_expect) %>%
    ts(start = 1950, end = 2021)
}
le_dev_ls
```

## Fit best ARIMA model

```{r}
# install.packages("forecast")
library(forecast)
le_dev_opt <- list()
for (dev in development_status) {
  le_dev_opt[[dev]] <- auto.arima(le_dev_ls[[dev]])
}
```


```{r}
p1 <- le_dev_opt$`Least developed countries` %>% 
  forecast(h = 5) %>% 
  autoplot()
p2 <- le_dev_opt$`More developed regions` %>%
  forecast(h = 5) %>% 
  autoplot()
p3 <- le_dev_opt$`Less developed regions, excluding least developed countries` %>%
  forecast(h = 5) %>% 
  autoplot()
p4 <- le_dev_opt$`Land-locked Developing Countries (LLDC)` %>%
  forecast(h = 5) %>% 
  autoplot()
p5 <- le_dev_opt$`Small Island Developing States (SIDS)` %>%
  forecast(h = 5) %>% 
  autoplot()

# display plots side by side
gridExtra::grid.arrange(p1, p2, p3, p4, p5, ncol = 2)
```



## ADF test

```{r}
library(tseries)
le_dev <- le_clean %>%
  filter(entity %in% development_status) %>% 
  select(entity, year, diff) %>% drop_na()
adf.test(le_dev %>% filter(entity == "More developed regions") %>% pull(diff))
```


# Global Vaccination Coverage

```{r}
vaccination_df <- read_csv("data/global-vaccination-coverage.csv")
vaccination_df %>% glimpse()
vaccination_clean <- janitor::clean_names(vaccination_df)

vaccination_long <- vaccination_clean %>% 
  pivot_longer(cols = -c(entity, code, year), 
               names_to = "vaccine", 
               values_to = "coverage")

```

```{r}
visdat::vis_miss(vaccination_long)
```

```{r}
WHO_regions <- stringr::str_subset(vaccination_df$Entity, "WHO") %>% unique()
p_vac <- vaccination_long %>% 
  filter(entity %in% WHO_regions) %>%
  ggplot(aes(x = year, y = coverage, color = vaccine)) +
  geom_line() + geom_point() +
  facet_wrap(~entity) +
  labs(title = "Global Vaccination Coverage by Year",
       x = "Year",
       y = "Coverage (%)")
ggplotly(p_vac)
```

